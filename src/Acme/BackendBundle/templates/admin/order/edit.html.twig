{% extends 'bt.html.twig' %}

{% block title %}订单详情{% endblock %}
{% block stylesheets %}
<style>

</style>
{% endblock %}
{% block javascripts %}
    <script>
        $(document).ready(function () {
            $("#btnClose").on("click", function () {
                if (!confirm("确认关闭订单?")) {
                    return false;
                }
                let url = '/admin/order/{{ model.id }}/close';
                let data = {order_mark: $("#order_mark").val(), addr_mark: $("#addr_mark").val()};
                $.post(url, data, function (r) {
                    if (r.code == '1') {
                        return showMsg(r.message);
                    }
                    showMsg({
                        msg: "操作成功.自动刷新页面", cb: function () {
                            location.reload()
                        }
                    });
                }, 'json');
            })
            $("#btnSend").on("click", function () {
                if (!confirm("确认发货?")) {
                    return false;
                }
                let url = '/admin/order/{{ model.id }}/shipping';
                let data = {order_mark: $("#order_mark").val(), addr_mark: $("#addr_mark").val(), shipping_id: [], shipping_no: []};
                $('input[name="shipping_id[]"]').each(function () {
                    data['shipping_id'].push($(this).val());
                })
                $('input[name="shipping_no[]"]').each(function () {
                    data['shipping_no'].push($(this).val());
                })
                $.post(url, data, function (r) {
                    if (r.code == '1') {
                        return showMsg(r.message);
                    }
                    showMsg({
                        msg: "操作成功.自动刷新页面", cb: function () {
                            location.reload()
                        }
                    });
                }, 'json');
            })
            $("#btnRefund").on("click", function () {
                if (!confirm("确认申请售后?")) {
                    return false;
                }
                let url = '/admin/order/{{ model.id }}/refund';
                let data = {order_mark: $("#order_mark").val(), addr_mark: $("#addr_mark").val()};
                $.post(url, data, function (r) {
                    if (r.code == '1') {
                        return showMsg(r.message);
                    }
                    showMsg({
                        msg: "操作成功.自动刷新页面", cb: function () {
                            location.reload()
                        }
                    });
                }, 'json');
            })
        })
    </script>
{% endblock %}
{% block body %}
    <h1>订单详情</h1>

    <hr/>
    <div class="row">

        <div class="row py-2">
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.createAt }}" readonly/>
                <label class="control-label ps-4">下单时间</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.orderNo }}" readonly/>
                <label class="control-label ps-4">订单编号</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.getOrderStatusStr }}" readonly/>
                <label class="control-label ps-4">订单状态</label>
            </div>
        </div>
        <div class="row py-2">
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.payTime }}" readonly/>
                <label class="control-label ps-4">付款时间</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ member.name }}" readonly/>
                <label class="control-label ps-4">会员</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ member.level }}" readonly/>
                <label class="control-label ps-4">下单等级</label>
            </div>
        </div>

        <div class="row py-2">
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.originAmount }}" readonly/>
                <label class="control-label ps-4">订单总价</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.discountAmount }}" readonly/>
                <label class="control-label ps-4">订单优惠</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.pointAmount }}" readonly/>
                <label class="control-label ps-4">积分优惠</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.couponAmount }}" readonly/>
                <label class="control-label ps-4">卡券优惠</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.shippingPrice }}" readonly/>
                <label class="control-label ps-4">物流价格</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.realAmount }}" readonly/>
                <label class="control-label ps-4">订单实付</label>
            </div>
        </div>
        <div class="row py-2">
            <div class="form-floating mb-3 col-md-1 col-sm-2">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.shippingWay }}" readonly/>
                <label class="control-label ps-4">物流</label>
            </div>
            <div class="form-floating mb-3 col-md-3 col-sm-4">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.addrName }} - {{ model.addrMobile }}" readonly/>
                <label class="control-label ps-4">收货人信息</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.address }}" readonly/>
                <label class="control-label ps-4">收货地址</label>
            </div>
        </div>

        <div class="row py-2">
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.shippingTime }}" readonly/>
                <label class="control-label ps-4">发货时间</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.confirmTime }}" readonly/>
                <label class="control-label ps-4">确认收货时间</label>
            </div>
            <div class="form-floating mb-3 col">
                <input type="text" class="form-control" placeholder="请输入..." value="{{ model.orderFrom }}" readonly/>
                <label class="control-label ps-4">订单来源</label>
            </div>
        </div>

        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="order_mark" placeholder="请输入..." value="{{ model.orderMark }}"/>
            <label class="control-label ps-4">订单备注</label>
        </div>

        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="addr_mark" placeholder="请输入..." value="{{ model.addrMark }}"/>
            <label class="control-label ps-4">快递备注</label>
        </div>
        <div class="order-goods">
            <table class="table">
                <thead>
                <tr>
                    <th>订单商品</th>
                    <th>商品数量</th>
                    <th>商品价格</th>
                    <th>商品实收</th>
                    <th>发货单号</th>
                </tr>
                </thead>
                <tbody>
                {% for p in goodsList %}
                    <tr>
                        <td>
                            <span class="float-start me-1">
                        <img class="img-thumbnail" width="60" height="60" src="{{ p.goods_logo }}"/></span>
                            <span class="float-start">{{ p.goods_name }}</span>
                        </td>
                        <td>
                            x{{ p.goods_num }}
                        </td>
                        <td>
                            x{{ p.origin_amount }}
                        </td>
                        <td>
                            x{{ p.real_aount }}
                        </td>
                        <td>
                            {% if model.shippingWay(true)==2 %}
                                自提
                            {% else %}
                                {% if p.shipping_status==1 %}
                                    {{ p.shipping_no }}
                                {% else %}
                                    <div class="form-group">
                                        <input type="text" class="form-control" name="shipping_no[]" placeholder="输入物流单号后点击发货"/>
                                        <input type="hidden" name="shipping_id[]" value="{{ p.id }}">
                                    </div>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="order-logs">
            <h6>订单操作日志</h6>
            <ul>
            {% for p in logList %}
                <li>{{ p.create_at }} - {{ p.message }} - {{ p.create_by }}</li>
            {% endfor %}
            </ul>
        </div>
        <div class="row py-2">
            {% if model.orderStatus==1 %}
                <div class="form-floating col-md-2">
                    <input type="button" value="关闭订单" id="btnClose" class="btn btn-primary"/>
                </div>
            {% endif %}

            {% if model.orderStatus==2 %}
                <div class="form-floating col-md-2">
                    <input type="button" value="订单发货" id="btnSend" class="btn btn-primary"/>
                </div>
            {% endif %}
            {% if (model.orderStatus==4 or model.orderStatus==3) %}
                <div class="form-floating col-md-2">
                    <input type="button" value="申请售后" id="btnRefund" class="btn btn-primary"/>
                </div>
            {% endif %}
            {% if (model.orderStatus==10) %}
                <div class="form-floating col-md-2">
                    <a href="/admin/refund/{{ model.refundId }}" class="btn btn-primary">查看退单</a>
                </div>
            {% endif %}
        </div>
    </div>
    <div>
        <a href="{{ path('admin_app_order_index') }}">back to list</a>
    </div>
{% endblock %}
